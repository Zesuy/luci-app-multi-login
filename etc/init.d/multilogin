#!/bin/sh /etc/rc.common

START=99
STOP=10

USE_PROCD=1
PROG=/etc/multilogin/login_control.bash

start_service() {
	local enabled
	config_load multilogin
	config_get enabled global enabled 0
	
	[ "$enabled" -eq 1 ] || {
		echo "MultiLogin is disabled in config"
		return 1
	}
	
	# 确保脚本存在且可执行
	[ -x "$PROG" ] || {
		echo "Login control script not found or not executable: $PROG"
		return 1
	}
	
	procd_open_instance
	procd_set_param command /bin/bash "$PROG"
	procd_set_param respawn ${respawn_threshold:-3600} ${respawn_timeout:-5} ${respawn_retry:-5}
	procd_set_param stdout 1
	procd_set_param stderr 1
	procd_close_instance
	
	logger -t multilogin "MultiLogin service started"
}

stop_service() {
	logger -t multilogin "MultiLogin service stopped"
}

reload_service() {
	stop
	start
}

service_triggers() {
	procd_add_reload_trigger "multilogin"
}
